# Какие варианты деплоя приложения?

*Проблема*: описания запуска приложения - 7-8 абстракций (deployment, service, configmap, pv, secrets) -> большой проект: больше 100 абстракций

*Решения*:
- `Sed/Envsubst` - утилиты обработки файлов (автозамена)
- `Ansible.kubernetes (jinja2) / Kustomize / Jsonnet` - средства шаблонизации проекта: в абстракциях меняем занчения на шаблон и приминяем через выбранное средство (при этом подменяя шаблон)

*Общее в решениях*:
- вход: набор шаблонизированных манифестов,
- конфигурация: набор конфигов с значениями шаблонов,
- деплой в кластер: пример, kubectl. 
Все они *kubectl-based* -> *нельзя откатить* манифесты при установке (кроме deployment - можно сделать rollout)

А если попробовать сохранить манифесты? Получается `Helm` (сохраняет архив с манифестами, принадлежащими релизу в секретах)

Альтернативы - концепция `GitOps`, пример - `ArgoCD`.

# Helm. Основы

1. Helm - это "пакетный менеджер" kubernetes (много похожих команд)
2. Курируется CNCF (компания, курирующая передовые продукты, в т.ч. kubernetes)
3. Декларативный формат
4. Фишки CD:
- отслеживание релиза (watch)
- автоматический релиз (rollback - если что-то пошло не так)
- hooks (очередность создания абстракций)
5. Система плагинов

Оперирует пакетами, `Чартом` - tgz-архивом, *состав*:
1. values.yml - значения переменных (обязательно)
2. /templates - шаблонизированные манифесты kubernetes (обязательно)
3. Chart.yml - метадата чарта (обязательны - name, version)

Идея - сделать единые манифест для каждой абстракции для всех приложений (единый темплейтированный deployment, service и т.д.). Каждый запуск - обновление файла с переменными + `helm install`

Язык шаблонизации - `Go template`. 

## Go-Templates

1. {{обращение к переменной или функции}}

_{{.Values.replicas}}_: values - список переменных, replicas - переменная
_"{{.Values.image.repository}}:{{.Values.image.tag}}"_ - в кавычках, т.к. могуть быть нечитаемые символы

2. Кроме {{.Values}}, можно обращаться к {{.Chart}} (метаданные чарта) и к параметрам командной строки {{.Release}} (helm install <имя релиза>)
3. Дефолтные значения: {{.Chart.name | default my-app }}
4. Переопределение значения при выполнении команды
```bash
helm template --set image.tag=1.13
```
5. Перенос куска yml из values.yml в шаблон: {{ toYaml Values.resources | indent 10}}. Indent - смещает вставляемый yml, чтобы соответствовать корректности yml.
6. Если переменная может быть, а может не быть:
```yml
{{ if Values.annotations }}
annotations:
{{- toYaml Values.annotations | indent 4}}
{{- end }}
```
Инчаче будет annotations: null. Минусы - убирают пустые строки в случае отсутвия Values.annotations. 
7. Итерация по значениям из файла:
```yml
- env:
{{ range $key, $val := Values.env }}
  - name: {{ $key | quote }}
    value: {{ $val | quote }}
{{ end }}
```
8. Включение других темплейтов: {{ include template.name }}

## Команды

```bash
helm search  # найти чарт
helm install # установить пакет
helm upgrade # обновить пакет
helm get   # скачать пакет
helm show  # показать информацию о пакете
helm list  # показать список пакетов
helm uninstall  # удалить пакет

helm template . # проверить правильность реализации чарта, показывает как шаблоны "поедут" в kubernrtes (. - находимся в директории чарта)
helm create <name>. # создать стартер, шаблонный чарт
```

## Деплой приложения

Чарты можно скачать из публичных репозиториев (например, https://charts.southbridge.ru/) или с официальных сайтов производителей ПО. 

## Тестирование релиза

Добавляем папку templates/tests/, куда можем положить манифесты сущностей, которые будут тестировать релиз (подключение к БД, готовность сервисов), например Job. 
Нужно добавить аннотацию _helm.sh/hook:test_.
Запуск в CI: _helm test <release_name>_.

## Хуки 
Сущность kubernetes, запуск которых привязан к событию (тот же Job, Pod).
События: _pre/post - install, delete, upgrade, rollback_. Порядок запуск хук при событии определяется _весом_ (weight)
Хуки в релиз не входят: нужно настраивать hook delete police, т.е. когда удалять хуку, так как она не удаляется сама после выполнения. 

## Практика

См. файл практики из репозитория Slerm. 

## Best Practices

1. Проверять репозиторий на безопасность и актуальность. \
Например смотреть warning kubernetes при установке чарта (могут быть depricated сущности)
2. Сохранять чарты в _локальном_ репозитории (как с кодом)
3. Использование стартеров (шаблонный чарт, база для создания своего чарта)

# Helm. Продвинутый уровень

# QA

# Links
1. Kustomize.
Примеры: [1](https://github.com/codefresh-contrib/kustomize-sample-app), [2](https://github.com/codefresh-contrib/kustomize-sample-app)
2. Go-Templates
[Библиотека темплейтов в Helm](https://masterminds.github.io/sprig/)
[Документация по go-templates](https://pkg.go.dev/text/template)


>> Continue >> 1:17:30
