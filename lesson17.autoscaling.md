# Horizontal pod autoscaler

**HPA** - сущность, увеличивающая или уменьшающая количество подов, основываясь на условиях. \
По сути - это еще один Controller (задается yml-файлом)

Для чего - подстраиваться под нагрузку на приложение (например через условие - использование CPU подом).

Нужно обязательно выставлять request по тому параметру (условие, метрика), который будет отслеживаться HPA. 

**Спецификация v1** - может отслеживать только одну метрику (утилизация процессора)
- maxReplicas 
- minReplicas
- scaleTargetRef - что скейлим
- targetCPUUtilizationPercentage - метрика 

**Спецификация v2** - может отслеживать разные метрики
Metrics: 
- metrics.type - ``метрики``, что отслеживаем: 
  * resource - cpu/memory
  * pod - любые мектрики с пода (например выведенные prometheus)
  * object - метрики с другого объекта кластера (metric - имя метрики, describedObject - где отслеживаем)
  * external - метрики с другого объекта вне кластера
- target - значение и как отслеживаем (AverageValue, AvarageUtulization - только для resources)

Пример реализации - чтение метрик из Prometheus с использованием **Prometheus adapter**. [Описание](https://github.com/kubernetes/metrics/blob/release-1.22/IMPLEMENTATIONS.md)

## Практика

```bash
kubectl top <node/pod> # check the load of something
kubectl expose deployment php-apache --port 80 # fast service createing
# create a HPA with the command instead of yaml files: what to scale - trigger - min/max amount of pods 
kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=5
kubectl get hpa 
```

## Best Practices
1. Если установка приложения через CI/CD + есть HPA -> в deployment не задавать реплики (иначе всегда будет скейлить до заданных в deployment при переустановке)

# Metrics server

Реализует возможность получения метрик приложения. Метрики собирает с компонентов kubelet, отвечающий за сбор метрик соответственно с подов. \
Данные о метриках не хранит, отдает значение в текущий момент. 

HPA для сбора метрик с Metrics server использует `APIService`. \
APIService - это абстракция, позволяющая KubeAPI маршрутизировать запросы к нему. Конфигурация кастомного APIService задается в yml-файле и включает в себя наименование:
- service (куда нужно смаршрутизировать запрос)
- group (для кого передавать запрос). 
По сути, благодаря этому механизму kubernetes может быть настроен как API-gateway. 

# Cluster auroscaler / Vertical pod autoscaler

`Cluster auroscaler` - добавление новых нод в кластер (когда нет свободных нод для запуска подов), только для облачных провайдеров (api провайдера). Серьезная экономия средств. 
Может работат не только с HPA:
- динамические раннеры CI/CD (отсутствие активности от разработчиков ночью - уменьшает стенд CI/CD)
- динамические стенды (временный стенд для тестирования приложения)

`Vertical pod autoscaler` - увеличение лимитов и реквестов для пода, вместо количества подов. Дополнительная функция - проставление аннотации `recommendation`, рекомендуемые реквесты/лимиты. 

# QA

1. Как узнавать о выходе ноых версий API?
Читать release notes новых версий kubernetes, ругается за несколько версий до изменений в консоль. 
2. Если нет свободных нод, как будет масштабироваться приложение?
Зависит от настройки podAntiAffinity: или приложение не будет запущено, или будет запущено на той же ноде. 
3. Доступен ли HPA из коробки?
Зависит от наличия Metrics server: (HPA v1) - доступен, HPA(v2) - нужна точно настройка админа. kubernetes реализует механизма масштабирования, но не реализует сбор метрик. 
4. Сколько тянет kubernetes? 
Зависит от профиля нагрузки, лектор максимально видел 100 нод. 